# 足球轨迹在空间坐标系的重建与足球运动初速度的计算

## 问题阐述
该项目面向"直接任意球"视频数据，目标是：

1. 从视频中提取足球的时序像素位置（2D 轨迹）；
2. 将其映射到以足球场边线为坐标轴、地面为坐标平面的空间坐标系中，重建（或在合理假设下估计）足球的三维运动轨迹；
3. 对地面投影曲线进行拟合（例如多项式/样条/物理模型参数化曲线）；
4. 在可识别的时间尺度与尺度标定条件下，估计足球初速度及相关物理量（如发射角、水平/竖直分量）。

> 说明：各模块目录下已包含 README.md 说明文档，全局配置参见 `config/config.yaml`。

## 空间坐标系与场地几何（用于标定/尺度）

题目要求"以足球场边线为坐标轴，地面为坐标平面"建立空间坐标系。为了把像素轨迹映射到场地坐标，需要依赖标准场地尺寸作为**尺度与几何约束**（详见 [A-Translate.md](../../../A-Translate.md)）。

**标准场地尺寸（单位：m）**

- 场地：$105\times 68$
- 球门：$7.32\times 2.44$
- 罚球点到球门线：$11$
- 罚球弧半径：$9.15$
- 中圈半径：$9.15$
- 罚球区（大禁区）：长 $40.32$，宽 $16.5$，距底线球门柱 $16.5$
- 球门区（小禁区）：长 $18.32$，宽 $5.5$，距底线球门柱 $5.5$
- 角球区半径：$1$

**推荐坐标系（与题意对齐）**

- 原点 $O$：取进攻方向一侧底线与边线交点（或你们在论文中约定的任意固定角点；关键是全程一致）。
- $X$ 轴：沿底线方向（与边线垂直，指向另一侧边线）。
- $Y$ 轴：沿边线方向（指向对方球门）。
- $Z$ 轴：竖直向上。

> 单机位视频常见做法是：先用场地线/球门等特征估计地面单应性，将像素点映射到地面 $(X,Y)$；如需 3D，再结合抛体约束/弱标定进一步估计 $Z$。

## 项目架构

```
HSC/
├─ config/
│  └─ config.yaml            # 全局配置文件（视频处理、检测、标定、拟合等参数）
├─ src/
│  ├─ video/                 # 原始视频
│  │  └─ Ball_video.mp4
│  └─ img/
│     ├─ frames/             # 抽帧输出的帧图像序列
│     └─ vis/                # 可视化输出
│        ├─ detection/       # 检测结果可视化
│        ├─ calibration/     # 标定可视化
│        ├─ reconstruction/  # 轨迹重建可视化
│        ├─ fitting/         # 曲线拟合可视化
│        └─ velocity/        # 速度估计可视化
├─ code/
│  ├─ MODEL1/                # 第1问：轨迹重建 + 初速度估计（本仓库核心）
│  │  ├─ Instruct.md         # 本说明文档
│  │  ├─ 1-vid2img/          # 抽帧/时间戳（fps、frame→t 映射）
│  │  │  └─ README.md
│  │  ├─ 2-point/            # 足球检测/跟踪（输出 2D 像素轨迹）
│  │  │  └─ README.md
│  │  ├─ 3-dataclean/        # 轨迹清洗/平滑/插值（处理缺失与离群）
│  │  │  └─ README.md
│  │  ├─ 4-field-calib/      # 场地几何与标定（线段/角点/球门→单应性/弱标定）
│  │  │  └─ README.md
│  │  ├─ 5-reconstruct/      # 2D→地面坐标；可选：弱 3D 重建/估计
│  │  │  └─ README.md
│  │  ├─ 6-fit-speed/        # 曲线拟合 + 初速度估计（含不确定性/置信区间）
│  │  │  └─ README.md
│  │  └─ 7-report/           # 可视化与导出（图、表、论文插图素材）
│  │     └─ README.md
│  ├─ MODEL2/                # 第2问：香蕉球/落叶球/电梯球动力学建模与分类
│  │  └─ README.md
│  └─ MODEL3/                # 第3问：人墙与门将策略分析
│     └─ README.md
├─ output/                   # 结构化输出数据
│  ├─ trajectory/            # 轨迹数据
│  │  ├─ 2d/                 # 2D 像素轨迹
│  │  └─ 3d/                 # 3D 场地轨迹
│  ├─ calibration/           # 标定数据
│  ├─ fitting/               # 拟合参数
│  ├─ velocity/              # 速度估计
│  └─ report/                # 汇总报告
│     └─ latex_figures/      # LaTeX 论文用图片副本
├─ A-Translate.md            # 题面翻译与约束（场地尺寸、任务要求等）
├─ article/                  # 参考资料（轨迹识别/建模/仿真等论文的双语稿）
└─ Tex/
   ├─ Template/              # LaTeX 论文模板（含已编译的 main.pdf）
   └─ 完整/                  # 另一份 LaTeX 示例/素材
```

### 数据产物约定

| 阶段 | 输出目录 | 文件 |
|------|----------|------|
| 抽帧 | `src/img/frames/` | `000001.jpg`, `000002.jpg`, ... |
| 检测 | `output/trajectory/2d/` | `trajectory_2d_raw.csv` |
| 清洗 | `output/trajectory/2d/` | `trajectory_2d_clean.csv`, `clean_report.json` |
| 标定 | `output/calibration/` | `homography.json`, `keypoints.json` |
| 重建 | `output/trajectory/3d/` | `trajectory_ground.csv`, `trajectory_3d.csv` |
| 拟合 | `output/fitting/` | `fit_params.json` |
| 速度 | `output/velocity/` | `v0.json` |
| 可视化 | `src/img/vis/` | 各类可视化图片 |
| 报告 | `output/report/` | `summary.json`, `summary.md` |

## 解决方案

本仓库的 **MODEL1（第1问）** 建议按"视觉测量 → 场地标定/尺度 → 重建 → 拟合 → 初速度估计"拆解。

### 1) 视频到 2D 轨迹（像素坐标）

- **抽帧/时间轴**：从视频抽取每一帧或固定 FPS（例如 25/30fps）。关键是保存帧序号与时间戳的对应关系：$t=i/\text{fps}$。
- **足球检测与跟踪**：
  - 传统：颜色/圆检测（Hough Circle）+ Kalman 滤波；
  - 学习：目标检测（YOLO 等）+ 跟踪（SORT/ByteTrack）。
- **输出**：得到按时间排序的 $(u_i, v_i, t_i)$（像素坐标系）。

### 2) 坐标系与尺度（从像素到场地坐标）

要回答"空间坐标系中的轨迹"，必须解决"尺度"和"相机几何"。可选路线如下（按信息需求从低到高）：

1. **地面平面（2D）重建**：优先用球场线条/角点/球门结构做单应性（Homography），将像素点映射到地面平面坐标 $(X, Y)$。
2. **在合理假设下估计 3D**：在单机位视频常见且缺乏完整标定时，可结合：
   - 已知尺寸（球门 $7.32\times 2.44$ m、场地 $105\times 68$ m、罚球点等）；
   - 抛体运动约束（不考虑/或简化空气阻力与马格努斯力时，轨迹近似抛物线）；
   - 通过最小二乘/非线性优化同时拟合"相机参数 + 3D 轨迹参数"。
3. **严格 3D 三角化**：若有多机位同步或可获取相机内外参，则用多视几何直接三角化得到 $(X, Y, Z)$。

### 3) 拟合与初速度估计

- **几何拟合（经验）**：
  - 地面投影曲线：多项式/样条拟合 $(X(t),Y(t))$ 或 $Y(X)$；
  - 高度：在 3D 可得时拟合 $Z(t)$。
- **物理拟合（推荐）**：使用受力模型（重力、空气阻力、马格努斯力）做参数反演，直接估计初速度 $\mathbf{v}_0$、旋转相关参数等。
- **初速度计算**：
  - 若得到 3D 轨迹：$\mathbf{v}_0\approx (\Delta\mathbf{x}/\Delta t)\vert_{t=t_0}$（建议用前几帧做线性回归/滤波估计，而不是单差分）；
  - 若仅 2D/地面：可得到水平速度分量的下界或在附加假设下的估计值。

## 操作流程

### A. 复现论文（LaTeX）

模板与已编译 PDF 位于 `Tex/Template/main.pdf` 与 `Tex/Template/main.tex`。

在 Windows 上建议使用 MiKTeX 或 TeX Live，并优先用 `latexmk`：

1. 进入模板目录：`Tex/Template/`
2. 编译（XeLaTeX）：`latexmk -xelatex -interaction=nonstopmode main.tex`

> 模板注释中提示需要 XeLaTeX 编译两次；`latexmk` 会自动处理多次编译与交叉引用。

### B. 视频数据准备

当前仓库内置示例视频：`src/video/Ball_video.mp4`。

建议约定：

- 输入视频：放在 `src/video/`
- 抽帧输出：放在 `src/img/frames/`

示例（使用 `ffmpeg` 抽帧到 30fps，按序号命名）：

```bash
ffmpeg -i src/video/Ball_video.mp4 -vf fps=30 src/img/frames/%06d.jpg
```

### C. 轨迹提取（各模块说明）

各模块详细接口说明请参见对应目录下的 README.md：

1. `code/MODEL1/1-vid2img/`：视频抽帧与时间戳管理
2. `code/MODEL1/2-point/`：足球检测/跟踪，输出 `trajectory_2d_raw.csv`
3. `code/MODEL1/3-dataclean/`：轨迹平滑、缺失点插值、异常点剔除
4. `code/MODEL1/4-field-calib/`：场地线/球门检测，建立地面单应性与尺度
5. `code/MODEL1/5-reconstruct/`：像素轨迹→地面坐标；可选：弱 3D 估计
6. `code/MODEL1/6-fit-speed/`：曲线拟合与初速度估计
7. `code/MODEL1/7-report/`：可视化与论文插图素材导出

输出文件建议至少包含以下字段（CSV）：

- 2D：`frame, t, u, v, score`
- 3D：`t, X, Y, Z`

### D. 结果展示与写作

- 可视化图片建议集中放在 `src/img/vis/`，便于在 LaTeX 中通过相对路径插入。
- 建议在 `A-Translate.md` 中列出的场地/球门尺寸处统一引用，避免写作中单位不一致。

## 优化方案

### 识别与跟踪

- **遮挡与运动模糊**：用跟踪（Kalman + 数据关联）补齐短时丢失；对低置信度帧做插值。
- **相机抖动**：先做视频稳像或用场地线特征做全局配准。
- **精度评估**：抽样人工标注作为 GT，报告像素误差与场地坐标误差。

### 标定与重建

- **用球场几何做弱标定**：利用边线、禁区线、球门立柱等稳定几何，增强单应性/外参解的稳定性。
- **不确定性传播**：把像素检测误差传到 $(X,Y,Z)$ 与 $\mathbf{v}_0$，给出置信区间而不是单点值。

### 物理模型

- **加入空气阻力/马格努斯力**：对"香蕉球/落叶球/电梯球"分类更有解释力（参考 `article/` 中综述与建模资料）。
- **参数反演**：用非线性最小二乘/贝叶斯方法估计 $\mathbf{v}_0$、旋转相关参数，使结果可解释且可比较。

### 工程化

- **配置化**：所有参数集中在 `config/config.yaml`，减少硬编码。
- **流水线化**：把"抽帧→检测→清洗→重建→拟合→输出"做成可一键运行的脚本/任务，便于复现实验。